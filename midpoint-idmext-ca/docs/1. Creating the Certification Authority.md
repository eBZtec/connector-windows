# Creating the Certification Authority (CA)

**1. Creating the CA Directory**

```
mkdir -p /tmp/ssl/CA
cd /tmp/ssl/CA
```

**2. Setting Up the CA Structure**

```
mkdir certs crl newcerts private
chmod 700 private
touch index.txt
echo 1000 > serial
```

**3. Creating an OpenSSL Configuration File**
Create the file `/tmp/ssl/CA/openssl.cnf` with the following content:

```
HOME			= .
openssl_conf = openssl_init
config_diagnostics = 1
oid_section = new_oids
[new_oids]
tsa_policy1 = 1.2.3.4.1
tsa_policy2 = 1.2.3.4.5.6
tsa_policy3 = 1.2.3.4.5.7

[openssl_init]
providers = provider_sect

[provider_sect]
default = default_sect

[default_sect]

[ca]
default_ca	= CA_default		# The default ca section

[CA_default]
dir             = /tmp/ssl/CA           # Where everything is kept
certs           = $dir/certs            # Where the issued certs are kept
crl_dir         = $dir/crl              # Where the issued crl are kept
database        = $dir/index.txt        # database index file.
new_certs_dir   = $dir/newcerts         # default place for new certs.
certificate     = $dir/certs/ca.cert.pem  # The CA certificate
serial          = $dir/serial           # The current serial number
crlnumber       = $dir/crlnumber        # the current crl number
crl             = $dir/crl.pem          # The current CRL
private_key     = $dir/private/ca.key.pem # The private key
x509_extensions = usr_cert              # The extensions to add to the cert
name_opt        = ca_default            # Subject Name options
cert_opt        = ca_default            # Certificate field options
default_days    = 365                   # how long to certify for
default_crl_days= 30                    # how long before next CRL
default_md      = default               # use public key default MD
preserve        = no                    # keep passed DN ordering
policy          = policy_match

[policy_match]
countryName		        = match
stateOrProvinceName	= optional
organizationName	= match
organizationalUnitName	= optional
commonName		        = supplied
emailAddress		    = optional

[policy_anything]
countryName		        = optional
stateOrProvinceName	= optional
localityName		    = optional
organizationName	    = optional
organizationalUnitName	= optional
commonName		        = supplied
emailAddress		    = optional

[req]
default_bits		    = 2048
default_keyfile 	    = privkey.pem
distinguished_name	    = req_distinguished_name
attributes		        = req_attributes
x509_extensions	        = v3_ca	# The extensions to add to the self signed cert
string_mask             = utf8only

[req_distinguished_name]
countryName                     = Country Name (2 letter code)
countryName_default             = BR
countryName_min                 = 2
countryName_max                 = 2
stateOrProvinceName             = State or Province Name (full name)
stateOrProvinceName_default     = Rio Grande do Sul
localityName                    = Locality Name (e.g., city)
localityName_default            = Encruzilhada do Sul
0.organizationName              = Organization Name (e.g., company)
0.organizationName_default      = eBZ Tecnologia
organizationalUnitName          = Organizational Unit Name (e.g., section)
organizationalUnitName_default  = LAB
commonName                      = Common Name (e.g., server FQDN or YOUR name)
commonName_max                  = 64
emailAddress                    = Email Address
emailAddress_max                = 64

[req_attributes]
challengePassword		        = A challenge password
challengePassword_min		    = 4
challengePassword_max		    = 20
unstructuredName		        = An optional company name

[usr_cert]
basicConstraints=CA:FALSE
subjectKeyIdentifier=hash
authorityKeyIdentifier=keyid,issuer

[v3_req]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment

[v3_ca]
subjectKeyIdentifier=hash
authorityKeyIdentifier=keyid:always,issuer
basicConstraints = critical,CA:true

[crl_ext]
authorityKeyIdentifier=keyid:always

[proxy_cert_ext]
basicConstraints=CA:FALSE
subjectKeyIdentifier=hash
authorityKeyIdentifier=keyid,issuer
proxyCertInfo=critical,language:id-ppl-anyLanguage,pathlen:3,policy:foo
```

**4. Generating the CA's Private Key**

```
openssl genrsa -aes256 -out private/ca.key.pem 4096
chmod 400 private/ca.key.pem
```
**Note:** Save the passphrase securely.

**5. Creating the CA_IDMEXT Certificate**

```
openssl req -config /tmp/ssl/CA/openssl.cnf -key private/ca.key.pem -new -x509 -days 3650 -sha256 -extensions v3_ca -out certs/ca.cert.pem
```

**Note:** OpenSSL will prompt for information to form the CA's DN.

**Set the CA's FQDN to "CA_IDMEXT"**

Example:

```
Country Name (2 letter code) [BR]:
State or Province Name (full name) [Rio Grande do Sul]:
Locality Name (e.g., city) [Encruzilhada do Sul]:
Organization Name (e.g., company) [eBZ Tecnologia]:
Organizational Unit Name (e.g., section) [LAB]:
Common Name (e.g., server FQDN or YOUR name) []:CA_IDMEXT
Email Address []:
```

## Creating Entity "MIDPOINT"

**1. Creating the "MIDPOINT" Entity Directory**

```
mkdir -p /tmp/ssl/clients/MIDPOINT
cd /tmp/ssl/clients/MIDPOINT
```

**2. Generating "MIDPOINT" Private Key**

```
openssl genrsa -out MIDPOINT.key.pem 2048
chmod 400 MIDPOINT.key.pem
```

**3. Creating "MIDPOINT" CSR (Certificate Signing Request)**

```
openssl req -new -key MIDPOINT.key.pem -out MIDPOINT.csr.pem
```

**Note:** As with the CA certificate, OpenSSL will prompt for information to form the DN for the certificate request. **Set the MIDPOINT Common Name to "MIDPOINT_IDMEXT"**. Example:

```
Country Name: BR
State or Province Name: RS
Locality Name: Encruzilhada do Sul
Organization Name: eBZ Tecnologia
Organizational Unit Name: LAB
Common Name: MIDPOINT_IDMEXT
Email Address []:
```

**4. Signing "MIDPOINT" Certificate with the CA**

```
cd /tmp/ssl/CA
openssl ca -config /tmp/ssl/CA/openssl.cnf -keyfile private/ca.key.pem -cert certs/ca.cert.pem -in /tmp/ssl/clients/MIDPOINT/MIDPOINT.csr.pem -out /tmp/ssl/clients/MIDPOINT/MIDPOINT.cert.pem -days 3650 -notext -md sha256
```

**5. Move CA's and MIDPOINT's folders to path:**

```
mv /tmp/ssl/CA /midpoint-idmext-ca/certificates
mv /tmp/ssl/clients/MIDPOINT /midpoint-idmext-ca/certificates
```

# Setting config.ini file

**1. Create a config.ini file in "midpoint-idmext-ca" directory and set the correspondent values:**

```ini
[postgresql]
host=localhost
port=5432
dbname=*
user=*
password=*

[server]
port=44880
CA_KEY_PASS=*
CA_KEY_PATH=path/to/ca.key.pem
CA_CERT_FILE=path/to/ca.cert.pem
MID_CERT_FILE=path/to/MIDPOINT.cert.pem
```



# Service Configuration:

**1. In project directory, create a virtual environment, activate it and install project requirements:**

```
python3 -m venv env
source env/bin/activate
```

**2. Make the file `midpoint-idmext-ca_server.sh` executable:**

```
chmod +x midpoint-idmext-ca_server.sh
```

**3. Create a service unit file `midpoint-idmext-ca.service` in the `/etc/systemd/system/` directory.** 
Replace the paths to the corresponding path file, set the "User" and "Group" with your username and set WorkingDirectory.

```
[Unit]
Description=Python Server running in virtual environment
After=network.target

[Service]
Type=simple
ExecStart=path/to/midpoint-idmext-ca_server.sh
Restart=on-failure
User=idmext
Group=idmext
WorkingDirectory=path/to/idmext/midpoint-idmext-ca

[Install]
WantedBy=multi-user.target
```

**4. Permanently configuring SELinux to allow the service:**

4.1 **Set the correct SELinux context:**
   You can change the context to one that allows execution, such as `bin_t`, which is used for executable files:
   ```bash
   sudo chcon -t bin_t /midpoint-idmext-ca/midpoint-idmext-ca-server.sh
   ```

4.2. **Make the change permanent:**
   To make this change survive a reboot or file relabeling, use `semanage`:
   ```bash
   sudo semanage fcontext -a -t bin_t "midpoint-idmext-ca-server.sh"
   sudo restorecon -v /midpoint-idmext-ca/midpoint-idmext-ca-server.sh
   ```


**5. Reload the systemd manager configuration:**

```
sudo systemctl daemon-reload
```

**6. Enable and start the service:**

```
sudo systemctl enable midpoint-idmext-ca.service
sudo systemctl start midpoint-idmext-ca.service
```

**7. To restart it, do:**

```
sudo systemctl restart midpoint-idmext-ca.service
```

**8. To check if service is running:**

```bash
sudo systemctl status midpoint-idmext-ca.service
```

# Notes

**1. The midpoint connector uses a "keystore.p12" file. It contains the midpoint_idmext certificate and private key created in this tutorial. To generate this file, run:**

```
openssl pkcs12 -export -out keystore.p12 -inkey /path/to/MIDPOINT.key.pem -in /path/to/MIDPOINT.cert.pem
```

The password configured for midpoint private key will be requested.
